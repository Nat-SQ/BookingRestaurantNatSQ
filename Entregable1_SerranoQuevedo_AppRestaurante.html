<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservaciones NatSQ - Reserva tu Mesa</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header>
        <div class="container">
            <h1>Reservaciones NatSQ</h1>
        </div>
    </header>

    <main class="container">
        <section id="restaurants-section">
            <h2>Elige tu tipo de cocina favorita</h2>
            <div id="restaurants-grid"></div>
        </section>

        <section id="booking-section" class="hidden">
            <div id="booking-header">
                <h2 id="booking-title"></h2>
                <button id="back-to-restaurants">&larr; Volver a Restaurantes</button>
            </div>

            <div class="booking-layout">
                <div id="selection-column">
                    <!-- Card de Filtros -->
                    <div class="filter-card">
                        <h3><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-80h80v80h320v-80h80v80h40q33 0 56.5 23.5T840-720v560q0 33-23.5 56.5T760-80H200Zm0-80h560v-400H200v400Zm0-480h560v-80H200v80Zm0 0v-80 80Z"/></svg> Date & Time</h3>
                        <div class="date-time-inputs">
                            <input type="date" id="booking-date">
                            <input type="time" id="booking-time">
                        </div>
                        <h3>Party Size</h3>
                        <div class="party-size-selector">
                            <button data-size="2" class="active">2 Ppl</button>
                            <button data-size="4">4 Ppl</button>
                            <button data-size="6">6 Ppl</button>
                            <button data-size="8">8 Ppl</button>
                        </div>
                    </div>

                    <!-- Mapa de Mesas -->
                    <div class="table-selection-card">
                        <h3>Selecciona tu mesa</h3>
                        <div class="table-legend">
                            <div class="legend-item"><span class="legend-dot" style="background-color: var(--available-color);"></span> Available</div>
                            <div class="legend-item"><span class="legend-dot" style="background-color: var(--occupied-color);"></span> Occupied</div>
                            <div class="legend-item"><span class="legend-dot" style="background-color: var(--primary-color);"></span> Selected</div>
                        </div>
                        <div id="table-map"></div>
                    </div>
                </div>

                <aside id="reservation-summary">
                    <h3>Resumen de tu Reserva</h3>
                    <h4>Pre-orden de Platillos:</h4>
                    <div id="menu-grid" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px;"></div>
                    <p id="total-price">Total: $0.00</p>
                    <hr style="margin: 20px 0;">
                    <form id="booking-form">
                        <div class="form-group">
                            <label for="name">Nombre Completo</label>
                            <input type="text" id="name" name="name" required>
                        </div>
                        <button type="submit" id="confirm-booking">Confirmar Reserva</button>
                    </form>
                </aside>
            </div>
        </section>
    </main>
    
    <div id="confirmation-modal" class="modal hidden">
        <div class="modal-content">
            <h2>¡Reserva Confirmada!</h2>
            <p>Hemos enviado los detalles a tu correo electrónico.</p>
            <p id="modal-summary"></p>
            <button id="close-modal">Aceptar</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- SELECTORES DEL DOM ---
        const restaurantsSection = document.getElementById('restaurants-section');
        const bookingSection = document.getElementById('booking-section');
        const restaurantsGrid = document.getElementById('restaurants-grid');
        const menuGrid = document.getElementById('menu-grid');
        const bookingTitle = document.getElementById('booking-title');
        const backButton = document.getElementById('back-to-restaurants');
        const tableMap = document.getElementById('table-map');
        const totalPriceEl = document.getElementById('total-price');
        const bookingForm = document.getElementById('booking-form');
        const modal = document.getElementById('confirmation-modal');
        const closeModalButton = document.getElementById('close-modal');
        const partySizeSelector = document.querySelector('.party-size-selector');
        const bookingDateInput = document.getElementById('booking-date');

        // --- ESTADO DE LA APLICACIÓN ---
        let selectedTable = null;
        let tableLockTimer = null; // setTimeout
        let countdownInterval = null; // setInterval
        let currentPartySize = 2;
        
        // Datos de las mesas (id, capacidad, estado inicial)
        const tablesData = [
            { id: 1, capacity: 2, status: 'available' }, { id: 2, capacity: 2, status: 'available' },
            { id: 3, capacity: 4, status: 'available' }, { id: 4, capacity: 4, status: 'available' },
            { id: 5, capacity: 6, status: 'occupied' }, { id: 6, capacity: 2, status: 'available' },
            { id: 7, capacity: 8, status: 'available' }, { id: 8, capacity: 4, status: 'occupied' },
            { id: 9, capacity: 2, status: 'available' }, { id: 10, capacity: 6, status: 'available' },
        ];

        const API_URL = 'https://www.themealdb.com/api/json/v1/1/';
        const PERSON_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Z"/></svg>`;

        // --- LÓGICA PRINCIPAL ---
        async function init() {
            setDefaultDateTime();
            const restaurants = await getRestaurants();
            if (restaurants) displayRestaurants(restaurants);
            addEventListeners();
        }

        function addEventListeners() {
            backButton.addEventListener('click', goBackToRestaurants);
            tableMap.addEventListener('click', handleTableClick);
            bookingForm.addEventListener('submit', handleFormSubmit);
            closeModalButton.addEventListener('click', () => {
                modal.classList.add('hidden');
                goBackToRestaurants();
            });
            partySizeSelector.addEventListener('click', handlePartySizeChange);
        }
        
        function setDefaultDateTime() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            bookingDateInput.value = today;
            bookingDateInput.min = today;
        }

        // --- NAVEGACIÓN Y VISTAS ---
        async function handleRestaurantClick(category) {
            restaurantsSection.classList.add('hidden');
            bookingSection.classList.remove('hidden');
            bookingTitle.textContent = `Reserva en ${category}`;
            
            resetBookingState();
            generateTables();
            filterTablesByPartySize();
            
            // Simulación de menú y precios
            menuGrid.innerHTML = `<p style="padding: 10px;">La pre-orden de platillos no está disponible para este restaurante.</p>`;
            totalPriceEl.textContent = `Total: $0.00`;
        }

        function goBackToRestaurants() {
            bookingSection.classList.add('hidden');
            restaurantsSection.classList.remove('hidden');
        }

        function resetBookingState() {
            clearTimeout(tableLockTimer);
            clearInterval(countdownInterval);
            tableLockTimer = null;
            countdownInterval = null;
            selectedTable = null;
            bookingForm.reset();
            setDefaultDateTime();
        }

        // --- LÓGICA DE MESAS ---
        function generateTables() {
            tableMap.innerHTML = '';
            tablesData.forEach(tableData => {
                const tableEl = document.createElement('div');
                tableEl.className = `table ${tableData.status}`;
                tableEl.dataset.tableId = tableData.id;
                tableEl.dataset.capacity = tableData.capacity;
                tableEl.innerHTML = `
                    <span class="table-name">T-${tableData.id}</span>
                    <div class="table-capacity">${PERSON_ICON_SVG}<span>${tableData.capacity}</span></div>
                `;
                tableMap.appendChild(tableEl);
            });
        }

        function handlePartySizeChange(e) {
            if (e.target.tagName !== 'BUTTON') return;
            
            partySizeSelector.querySelector('.active').classList.remove('active');
            e.target.classList.add('active');
            currentPartySize = parseInt(e.target.dataset.size, 10);
            
            filterTablesByPartySize();
        }

        function filterTablesByPartySize() {
            const allTables = tableMap.querySelectorAll('.table');
            allTables.forEach(table => {
                const capacity = parseInt(table.dataset.capacity, 10);
                const isSelected = table.classList.contains('selected');
                
                // Si la mesa no está seleccionada y su capacidad es menor a la requerida, se ocupa
                if (!isSelected && capacity < currentPartySize) {
                    table.classList.remove('available');
                    table.classList.add('occupied');
                } 
                // Si no está ocupada por defecto y cumple la capacidad, se libera
                else if (tablesData.find(t => t.id == table.dataset.tableId).status !== 'occupied') {
                    table.classList.remove('occupied');
                    table.classList.add('available');
                }
            });
        }

        function handleTableClick(e) {
            const table = e.target.closest('.table');
            if (!table || table.classList.contains('occupied')) return;

            // Si se hace clic en la mesa ya seleccionada, no hacer nada
            if (selectedTable === table) return;

            // Limpiar selección y timer anterior
            clearSelectionAndTimer();

            // Seleccionar nueva mesa
            selectedTable = table;
            table.classList.remove('available');
            table.classList.add('selected');

            // Iniciar temporizador de bloqueo y visual
            startLockTimer(table);
        }
        
        function clearSelectionAndTimer() {
            if (selectedTable) {
                selectedTable.classList.remove('selected');
                selectedTable.classList.add('available');
                const timerBadge = selectedTable.querySelector('.timer-badge');
                if (timerBadge) timerBadge.remove();
            }
            clearTimeout(tableLockTimer);
            clearInterval(countdownInterval);
        }

        function startLockTimer(table) {
            let timeLeft = 300; // 5 minutos en segundos
            
            const timerBadge = document.createElement('div');
            timerBadge.className = 'timer-badge';
            table.appendChild(timerBadge);

            const updateTimer = () => {
                const minutes = Math.floor(timeLeft / 60);
                let seconds = timeLeft % 60;
                seconds = seconds < 10 ? '0' + seconds : seconds;
                timerBadge.textContent = `${minutes}:${seconds}`;
                timeLeft--;
            };
            
            updateTimer();
            countdownInterval = setInterval(updateTimer, 1000);

            tableLockTimer = setTimeout(() => {
                alert(`El tiempo para la Mesa ${table.dataset.tableId} ha expirado.`);
                clearSelectionAndTimer();
                filterTablesByPartySize(); // Re-aplicar filtro
            }, 300000);
        }

        // --- FORMULARIO Y CONFIRMACIÓN ---
        function handleFormSubmit(e) {
            e.preventDefault();
            if (!selectedTable) {
                alert('Por favor, selecciona una mesa.');
                return;
            }
            
            const tableId = selectedTable.dataset.tableId;
            const tableData = tablesData.find(t => t.id == tableId);
            tableData.status = 'occupied'; // Marcar como ocupada permanentemente

            clearTimeout(tableLockTimer);
            clearInterval(countdownInterval);

            document.getElementById('modal-summary').textContent = `Reserva para ${document.getElementById('name').value} en la Mesa ${tableId}.`;
            modal.classList.remove('hidden');
        }

        // --- FUNCIONES API (Simplificadas) ---
        async function getRestaurants() {
            try {
                const response = await fetch(`${API_URL}categories.php`);
                const data = await response.json();
                return data.categories;
            } catch (error) { console.error('Error:', error); }
        }

        function displayRestaurants(restaurants) {
            restaurantsGrid.innerHTML = '';
            restaurants.forEach(r => {
                const card = document.createElement('div');
                card.className = 'restaurant-card';
                card.innerHTML = `<img src="${r.strCategoryThumb}" alt="${r.strCategory}"><h3>${r.strCategory}</h3>`;
                card.addEventListener('click', () => handleRestaurantClick(r.strCategory));
                restaurantsGrid.appendChild(card);
            });
        }

        init();
    });
    </script>

</body>
</html>